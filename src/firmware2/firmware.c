#define R_DIP (*(volatile int *)0x80000000)
#define R_LED (*(volatile int *)0x80000004)
#define R_BUTTONS (*(volatile int *)0x80000008)
#define R_AUDIO_STATUS (*(volatile int *)0x8000000c)
#define R_AUDIO_LEFT (*(volatile int *)0x80000010)
#define R_AUDIO_RIGHT (*(volatile int *)0x80000014)

#define IRQ_TIMER (1 << 0)
#define IRQ_ILLINSN (1 << 1)
#define IRQ_BUSERR (1 << 2)
#define IRQ_BTN_U (1 << 3)
#define IRQ_BTN_R (1 << 4)
#define IRQ_BTN_L (1 << 5)
#define IRQ_BTN_D (1 << 6)
#define IRQ_BTN_C (1 << 7)

#define AUDIO_STATUS_FIFO_FULL (1 << 0)
#define AUDIO_STATUS_CONFIGURED (1 << 1)

int maskirq(int mask);
int waitirq(void);
unsigned int timer(unsigned int cycles);

static const int sin_lut[256] = {
    0x000000, 0x03242a, 0x0647d9, 0x096a90, 0x0c8bd3, 0x0fab27, 0x12c810, 0x15e214,
    0x18f8b8, 0x1c0b82, 0x1f19f9, 0x2223a4, 0x25280c, 0x2826b8, 0x2b1f34, 0x2e110a,
    0x30fbc4, 0x33def2, 0x36ba1f, 0x398cdc, 0x3c56b9, 0x3f1749, 0x41ce1d, 0x447acc,
    0x471cec, 0x49b414, 0x4c3fdf, 0x4ebfe8, 0x5133cb, 0x539b2a, 0x55f5a4, 0x5842dc,
    0x5a8278, 0x5cb420, 0x5ed77b, 0x60ec37, 0x62f200, 0x64e888, 0x66cf80, 0x68a69d,
    0x6a6d97, 0x6c2428, 0x6dca0c, 0x6f5f01, 0x70e2ca, 0x72552b, 0x73b5ea, 0x7504d2,
    0x7641ae, 0x776c4d, 0x788483, 0x798a22, 0x7a7d04, 0x7b5d02, 0x7c29fa, 0x7ce3cd,
    0x7d8a5e, 0x7e1d92, 0x7e9d54, 0x7f0990, 0x7f6235, 0x7fa735, 0x7fd886, 0x7ff620,
    0x7fffff, 0x7ff620, 0x7fd886, 0x7fa735, 0x7f6235, 0x7f0990, 0x7e9d54, 0x7e1d92,
    0x7d8a5e, 0x7ce3cd, 0x7c29fa, 0x7b5d02, 0x7a7d04, 0x798a22, 0x788483, 0x776c4d,
    0x7641ae, 0x7504d2, 0x73b5ea, 0x72552b, 0x70e2ca, 0x6f5f01, 0x6dca0c, 0x6c2428,
    0x6a6d97, 0x68a69d, 0x66cf80, 0x64e888, 0x62f200, 0x60ec37, 0x5ed77b, 0x5cb420,
    0x5a8278, 0x5842dc, 0x55f5a4, 0x539b2a, 0x5133cb, 0x4ebfe8, 0x4c3fdf, 0x49b414,
    0x471cec, 0x447acc, 0x41ce1d, 0x3f1749, 0x3c56b9, 0x398cdc, 0x36ba1f, 0x33def2,
    0x30fbc4, 0x2e110a, 0x2b1f34, 0x2826b8, 0x25280c, 0x2223a4, 0x1f19f9, 0x1c0b82,
    0x18f8b8, 0x15e214, 0x12c810, 0x0fab27, 0x0c8bd3, 0x096a90, 0x0647d9, 0x03242a,
    0x000000, 0xfcdbd6, 0xf9b827, 0xf69570, 0xf3742d, 0xf054d9, 0xed37f0, 0xea1dec,
    0xe70748, 0xe3f47e, 0xe0e607, 0xdddc5c, 0xdad7f4, 0xd7d948, 0xd4e0cc, 0xd1eef6,
    0xcf043c, 0xcc210e, 0xc945e1, 0xc67324, 0xc3a947, 0xc0e8b7, 0xbe31e3, 0xbb8534,
    0xb8e314, 0xb64bec, 0xb3c021, 0xb14018, 0xaecc35, 0xac64d6, 0xaa0a5c, 0xa7bd24,
    0xa57d88, 0xa34be0, 0xa12885, 0x9f13c9, 0x9d0e00, 0x9b1778, 0x993080, 0x975963,
    0x959269, 0x93dbd8, 0x9235f4, 0x90a0ff, 0x8f1d36, 0x8daad5, 0x8c4a16, 0x8afb2e,
    0x89be52, 0x8893b3, 0x877b7d, 0x8675de, 0x8582fc, 0x84a2fe, 0x83d606, 0x831c33,
    0x8275a2, 0x81e26e, 0x8162ac, 0x80f670, 0x809dcb, 0x8058cb, 0x80277a, 0x8009e0,
    0x800001, 0x8009e0, 0x80277a, 0x8058cb, 0x809dcb, 0x80f670, 0x8162ac, 0x81e26e,
    0x8275a2, 0x831c33, 0x83d606, 0x84a2fe, 0x8582fc, 0x8675de, 0x877b7d, 0x8893b3,
    0x89be52, 0x8afb2e, 0x8c4a16, 0x8daad5, 0x8f1d36, 0x90a0ff, 0x9235f4, 0x93dbd8,
    0x959269, 0x975963, 0x993080, 0x9b1778, 0x9d0e00, 0x9f13c9, 0xa12885, 0xa34be0,
    0xa57d88, 0xa7bd24, 0xaa0a5c, 0xac64d6, 0xaecc35, 0xb14018, 0xb3c021, 0xb64bec,
    0xb8e314, 0xbb8534, 0xbe31e3, 0xc0e8b7, 0xc3a947, 0xc67324, 0xc945e1, 0xcc210e,
    0xcf043c, 0xd1eef6, 0xd4e0cc, 0xd7d948, 0xdad7f4, 0xdddc5c, 0xe0e607, 0xe3f47e,
    0xe70748, 0xea1dec, 0xed37f0, 0xf054d9, 0xf3742d, 0xf69570, 0xf9b827, 0xfcdbd6,
};

static const unsigned int notes[8] = {
    // 2**32 * freq / sample_rate
    0x01653650,  // C4
    0x01915df6,  // D4
    0x01c20e09,  // E4
    0x01dcd0bb,  // F4
    0x021735ee,  // G4
    0x0258bf25,  // A4
    0x02a24f92,  // B4
    0x02ca6921,  // C5
};

volatile static unsigned char note;

void irq_handler(void *irq_return_address, int irq_mask)
{
    if(irq_mask & IRQ_BTN_L)
        note = (note - 1) & 7;
    if(irq_mask & IRQ_BTN_R)
        note = (note + 1) & 7;
}

int main(void)
{
    while(!(R_AUDIO_STATUS & AUDIO_STATUS_CONFIGURED))
        ;

    note = 0;

    maskirq(~(IRQ_BTN_L | IRQ_BTN_R));

    unsigned int phase = 0;
    while(1) {
        unsigned int sample = sin_lut[phase >> 24];
        unsigned char n = note;
        phase += notes[n];
        R_LED = 1 << n;
        while(R_AUDIO_STATUS & AUDIO_STATUS_FIFO_FULL)
            ;
        R_AUDIO_LEFT = sample;
        R_AUDIO_RIGHT = sample;
    }
}
